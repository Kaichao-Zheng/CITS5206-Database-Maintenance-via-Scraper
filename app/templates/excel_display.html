{% extends 'layout.html' %}{% block main_content %}
<div id="hot" class="w-full h-full"></div>
<div class="fixed bottom-4 right-4 flex gap-4">
  <button id="saveBtn" class="button cursor-pointer w-24 bg-violet-700 text-white rounded-md py-2 hover:bg-violet-800 transition-colors duration-300">ğŸ’¾ Save</button>
  <button id="exportBtn" class="button cursor-pointer w-24 bg-violet-700 text-white rounded-md py-2 hover:bg-violet-800 transition-colors duration-300">â¬‡ï¸ Export</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('hot');
  console.log('Sending request to /data...');
  // Fetch data from the /data endpoint
  fetch('/data')
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! Status: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      console.log('Data received from /data:', data); 
      if (!data || !Array.isArray(data) || data.length === 0) {
        alert('No data available to display.');
        return;
      }

      // Define column headers based on field_mapping keys for display
      const displayColumns = [
      'first_name', 'last_name', 'salutation', 'organization', 'role',
      'gender', 'city', 'state', 'country', 'business_phone', 'mobile_phone',
      'email', 'sector', 'linkedin'
      ];

      const colHeaders = [
      'FirstName', 'LastName', 'Salutation', 'Organization', 'Role',
      'Gender', 'City (if outside AUS)', 'State AUS only', 'Country', 'Business Phone',
      'Mobile Phone', 'EmailAddress', 'Sector', 'Linkedin'
      ];
      // Initialize Handsontable
      const hot = new Handsontable(container, {
       data: data,
        rowHeaders: true,
        colHeaders: colHeaders,
        columns: displayColumns.map(col => ({ data: col })),
        filters: true,
        dropdownMenu: true,
        width: '100%', // Full width of the container
        height: 'calc(100vh - 80px)', // Full height minus space for buttons and padding
        autoWrapRow: true,
        autoWrapCol: true,
        minRows: 1,
        minSpareRows: 1,
        licenseKey: 'non-commercial-and-evaluation'
      });

      // Save button event listener
      document.getElementById('saveBtn').addEventListener('click', () => {
        const updatedData = hot.getSourceData();
        console.log('Sending updated data to /update:', updatedData);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        fetch('/update', {
          method: 'POST',
          headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken   
        },
          body: JSON.stringify(updatedData)
        })
        .then(async res => {
        const text = await res.text();
        console.log("Raw /update response:", text);  // ğŸ” æ‰“å°çœ‹çœ‹æ˜¯ä¸æ˜¯ HTML
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error("Not valid JSON, response was: " + text.slice(0, 200));
        }
      })
        .then(res => {
          if (res.status === 'success') {
            alert('Saved!');
          } else {
            alert('Error: ' + res.error);
          }
        })
        .catch(err => alert('Error saving data: ' + err.message));
      });

      // Export button event listener
      document.getElementById('exportBtn').addEventListener('click', () => {
        window.location.href = '/export';
      });
    })
    .catch(err => {
      console.error('Error fetching data:', err);
      alert('Failed to load data: ' + err.message);
    });
});
</script>
{% endblock %}