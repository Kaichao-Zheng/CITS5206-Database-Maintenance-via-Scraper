{% extends 'layout.html' %}{% block main_content %}
<div id="hot" class="w-full h-full"></div>
<div class="fixed bottom-4 right-4 flex gap-4">
  <button id="saveBtn" class="button cursor-pointer w-24 bg-violet-700 text-white rounded-md py-2 hover:bg-violet-800 transition-colors duration-300">💾 Save</button>
  <button id="exportBtn" class="button cursor-pointer w-24 bg-violet-700 text-white rounded-md py-2 hover:bg-violet-800 transition-colors duration-300">⬇️ Export</button>
</div>

<script>

document.addEventListener('DOMContentLoaded', () => {
  // Email validation function using validator.js
  const isValidEmail = (email) => {
    if (!email || typeof email !== 'string') return false;
    // Use validator.js for comprehensive email validation
    return validator.isEmail(email.trim(), {
      allow_display_name: false,
      require_display_name: false,
      allow_utf8_local_part: true,
      require_tld: true,
      ignore_max_length: false
    });
  };

  const wrongEmailAddressRenderer = (instance, td, row, col, prop, value, cellProperties) => {
    // Apply default text renderer first
    Handsontable.renderers.TextRenderer(instance, td, row, col, prop, value, cellProperties);

    // Get row data to check FirstName and LastName
    const rowData = instance.getDataAtRow(row);
    const firstName = rowData[0]; // FirstName is column 0
    const lastName = rowData[1];  // LastName is column 1

    // Skip validation if FirstName or LastName is empty
    if (!firstName || !lastName || 
        firstName.toString().trim() === '' || 
        lastName.toString().trim() === '') {
      // Remove any existing invalid styling
      td.classList.remove('invalid-email');
      td.style.color = '';
      td.style.backgroundColor = '';
      td.style.fontWeight = '';
      return; // Skip email validation
    }

    // Check if email is invalid (only when FirstName and LastName exist)
    if (!isValidEmail(value)) {
      // Add class for styling invalid emails
      td.classList.add('invalid-email');
      td.style.color = '#dc3545'; // Red color
      td.style.backgroundColor = '#f8d7da'; // Light red background
      td.style.fontWeight = 'bold';
    } else {
      // Remove invalid styling if email becomes valid
      td.classList.remove('invalid-email');
      td.style.color = '';
      td.style.backgroundColor = '';
      td.style.fontWeight = '';
    }
  };

  Handsontable.renderers.registerRenderer('wrongEmailAddressRenderer', wrongEmailAddressRenderer);
  const container = document.getElementById('hot');
  console.log('Sending request to /data...');
  // Fetch data from the /data endpoint
  fetch('/data')
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! Status: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      console.log('Data received from /data:', data); 
      if (!data || !Array.isArray(data) || data.length === 0) {
        alert('No data available to display.');
        return;
      }

      // Define column headers based on field_mapping keys for display
      const displayColumns = [
      'first_name', 'last_name', 'salutation', 'organization', 'role',
      'gender', 'city', 'state', 'country', 'business_phone', 'mobile_phone',
      'email', 'sector', 'linkedin'
      ];

      const colHeaders = [
      'FirstName', 'LastName', 'Salutation', 'Organization', 'Role',
      'Gender', 'City (if outside AUS)', 'State AUS only', 'Country', 'Business Phone',
      'Mobile Phone', 'EmailAddress', 'Sector', 'Linkedin'
      ];
      // Initialize Handsontable
      const hot = new Handsontable(container, {
       data: data,
        rowHeaders: true,
        colHeaders: colHeaders,
        columns: displayColumns.map(col => ({ data: col })),
        filters: true,
        dropdownMenu: true,
        width: '100%', // Full width of the container
        height: 'calc(100vh - 80px)', // Full height minus space for buttons and padding
        cells(row, col) {
          const cellProperties = {};
          const data = this.instance.getData();
          console.log('Handsontable Data:', data);
          if (col === 11) { // EmailAddress is the 12th column (index 11)
            cellProperties.renderer = 'wrongEmailAddressRenderer'; // Use string reference
          }
          return cellProperties;
        },
        autoWrapRow: true,
        autoWrapCol: true,
        minRows: 1,
        minSpareRows: 1,
        licenseKey: 'non-commercial-and-evaluation'
      });

      // Save button event listener
      document.getElementById('saveBtn').addEventListener('click', () => {
        const updatedData = hot.getSourceData();
        console.log('Sending updated data to /update:', updatedData);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        fetch('/update', {
          method: 'POST',
          headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken   
        },
          body: JSON.stringify(updatedData)
        })
        .then(async res => {
        const text = await res.text();
        console.log("Raw /update response:", text);  // check if the response is valid JSON
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error("Not valid JSON, response was: " + text.slice(0, 200));
        }
      })
        .then(res => {
          if (res.status === 'success') {
            alert('Saved!');
          } else {
            alert('Error: ' + res.error);
          }
        })
        .catch(err => alert('Error saving data: ' + err.message));
      });

      // Export button event listener
      document.getElementById('exportBtn').addEventListener('click', () => {
        window.location.href = '/export';
      });
    })
    .catch(err => {
      console.error('Error fetching data:', err);
      alert('Failed to load data: ' + err.message);
    });
});
</script>
{% endblock %}