{% extends 'layout.html' %} {% block main_content %}

<div
  id="loading-overlay"
  class="hidden fixed inset-0 bg-[#d0bcfe] bg-opacity-50 z-50 flex items-center justify-center"
>
  <div class="bg-white p-6 rounded-lg shadow-xl text-center">
    <div
      class="animate-spin rounded-full h-12 w-12 border-b-2 border-violet-700 mx-auto mb-4"
    ></div>
    <p class="text-lg">Updating databases...</p>
    <p class="text-sm text-gray-600 mt-2">
      This may take several minutes, please do not close this page.
    </p>
  </div>
</div>

<div class="flex flex-col items-center justify-center w-full h-full gap-8">
  <a
    href="{{ url_for('auth.change_password') }}"
    class="button"
    id="change-password-btn"
    >Change Password</a
  >
  <a
    href="{{ url_for('auth.change_email') }}"
    class="button"
    id="change-email-btn"
    >Change Email</a
  >
  <div class="flex flex-col items-center gap-2">
    <button id="update-db" class="button">Update Local Databases</button>
    <p id="update-db-status"></p>
  </div>
</div>

<script>
  const buttons = document.querySelectorAll("a.button, button.button");
  const overlay = document.getElementById("loading-overlay");

  function disableNavigation(disable) {
    buttons.forEach((button) => {
      button.style.pointerEvents = disable ? "none" : "auto";
      button.style.opacity = disable ? "0.5" : "1";
    });
    overlay.classList.toggle("hidden", !disable);
  }

  // Add event listener to handle page navigation attempts
  window.addEventListener("beforeunload", (e) => {
    if (!overlay.classList.contains("hidden")) {
      e.preventDefault();
      e.returnValue =
        "Changes are being saved. Are you sure you want to leave?";
    }
  });

  document.getElementById("update-db").addEventListener("click", async () => {
    disableNavigation(true);
    document.getElementById("update-db-status").innerText = "";

    const headers = {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token() }}",
    };

    try {
      // Run both fetches at the same time
      const [govResponse, seResponse] = await Promise.all([
        fetch("/gov_update", { method: "POST", headers }),
        fetch("/senator_update", { method: "POST", headers }),
      ]);

      // Handle government response
      if (govResponse.ok) {
        document.getElementById("update-db-status").innerText =
          "Government database updated successfully.";
      } else {
        const errorData = await govResponse.json();
        document.getElementById("update-db-status").innerText =
          "Error updating government DB: " +
          (errorData.message || "Unknown error.");
      }

      // Handle senator response
      if (seResponse.ok) {
        document.getElementById("update-db-status").innerText =
          "Senator database updated successfully.";
      } else {
        const errorData = await seResponse.json();
        document.getElementById("update-db-statuss").innerText =
          "Error updating senator DB: " +
          (errorData.message || "Unknown error.");
      }
    } catch (error) {
      document.getElementById("update-db-status").innerText =
        "Error: " + error.message;
      document.getElementById("update-db-status").innerText =
        "Error: " + error.message;
    } finally {
      disableNavigation(false);
    }
  });
</script>
{% endblock %}
